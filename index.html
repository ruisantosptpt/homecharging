<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home Charger Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #0d0d0d;
      color: white;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #1a1a1a;
      padding: 10px 20px;
    }

    .container {
      display: flex;
      padding: 20px;
    }

    .left-panel, .right-panel {
      flex: 1;
      margin: 0 10px;
      background-color: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
    }

    h2 {
      margin-top: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #333;
      text-align: left;
    }

    .settings {
      display: none;
      background-color: #1a1a1a;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 10px;
    }

    .settings.visible {
      display: block;
    }

    .insert-consumption {
      background-color: #1a1a1a;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 10px;
    }

    .month-nav {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .month-nav button {
      margin: 0 10px;
      padding: 5px 10px;
    }

    input {
      margin: 0 10px 10px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>Home Charger Tracker</h1>
    <div>
      <button onclick="prevMonth()">←</button>
      <span id="monthLabel"></span>
      <button onclick="nextMonth()">→</button>
      <button onclick="toggleSettings()">⚙️</button>
    </div>
  </header>

  <div class="insert-consumption">
    <label>Valor: <input type="number" id="valueInput" /></label>
    <label>Data: <input type="date" id="dateInput" /></label>
    <button onclick="addEntry('kWh')">kWh</button>
    <button onclick="addEntry('%')">%</button>
  </div>

  <div class="settings" id="settingsPanel">
    <label>Preço kWh (€): <input type="number" id="priceKWh" step="0.01" /></label><br>
    <label>Preço Gasóleo (€): <input type="number" id="priceDiesel" step="0.01" /></label><br>
    <label>Meta Mensal (€): <input type="number" id="monthlyGoal" step="0.01" /></label>
  </div>

  <div class="container">
    <div class="left-panel">
      <h2 id="monthTitle"></h2>
      <table id="dataTable">
        <thead>
          <tr><th>Data</th><th>kWh</th><th>Custo</th><th></th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td>Total</td><td id="totalKWh"></td><td id="totalCost"></td><td></td></tr>
        </tfoot>
      </table>
    </div>
    <div class="right-panel">
      <h2>Gráfico Anual</h2>
      <canvas id="annualChart"></canvas>
    </div>
  </div>

  <script>
    const data = JSON.parse(localStorage.getItem('chargingData') || '{}');
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    const priceKWhInput = document.getElementById('priceKWh');
    const priceDieselInput = document.getElementById('priceDiesel');
    const monthlyGoalInput = document.getElementById('monthlyGoal');
    const monthLabel = document.getElementById('monthLabel');
    const settingsPanel = document.getElementById('settingsPanel');
    const ctx = document.getElementById('annualChart').getContext('2d');
    let chart;

    function formatarDataCompleta(dataString) {
      const data = new Date(dataString);
      const dias = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
      const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                     'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      
      const diaSemana = dias[data.getDay()];
      const dia = data.getDate();
      const mes = meses[data.getMonth()];

      return `${diaSemana}, ${dia} ${mes}`;
    }

    function saveData() {
      localStorage.setItem('chargingData', JSON.stringify(data));
    }

    function toggleSettings() {
      settingsPanel.classList.toggle('visible');
    }

    function updateTable() {
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';
      const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
      const entries = data[monthKey] || [];

      let totalKWh = 0;
      let totalCost = 0;

      entries.forEach((entry, index) => {
        const row = document.createElement('tr');
        const tdData = document.createElement('td');
        const tdKWh = document.createElement('td');
        const tdCost = document.createElement('td');
        const tdDelete = document.createElement('td');
        const cost = entry.kWh * (parseFloat(priceKWhInput.value) || 0);

        tdData.textContent = formatarDataCompleta(entry.date);
        tdKWh.textContent = entry.kWh.toFixed(2);
        tdCost.textContent = cost.toFixed(2) + ' €';
        tdDelete.innerHTML = `<button onclick="deleteEntry(${index})">❌</button>`;

        row.appendChild(tdData);
        row.appendChild(tdKWh);
        row.appendChild(tdCost);
        row.appendChild(tdDelete);
        tbody.appendChild(row);

        totalKWh += entry.kWh;
        totalCost += cost;
      });

      document.getElementById('totalKWh').textContent = totalKWh.toFixed(2);
      document.getElementById('totalCost').textContent = totalCost.toFixed(2) + ' €';
    }

    function addEntry(type) {
      const value = parseFloat(document.getElementById('valueInput').value);
      const date = document.getElementById('dateInput').value;
      if (!value || !date) return;

      const monthKey = `${new Date(date).getFullYear()}-${String(new Date(date).getMonth() + 1).padStart(2, '0')}`;
      data[monthKey] = data[monthKey] || [];

      let kWhValue = value;
      if (type === '%') {
        kWhValue = value / 100 * 60; // suposição: 60kWh capacidade total
      }

      data[monthKey].push({ kWh: kWhValue, date });
      saveData();
      if (monthKey === `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`) {
        updateTable();
        updateChart();
      }
    }

    function deleteEntry(index) {
      const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
      data[monthKey].splice(index, 1);
      saveData();
      updateTable();
      updateChart();
    }

    function updateChart() {
      const labels = [];
      const kWhData = [];
      const euroData = [];

      for (let i = 0; i < 12; i++) {
        const key = `${currentYear}-${String(i + 1).padStart(2, '0')}`;
        const entries = data[key] || [];
        const totalKWh = entries.reduce((sum, entry) => sum + entry.kWh, 0);
        const totalCost = totalKWh * (parseFloat(priceKWhInput.value) || 0);

        labels.push(new Date(currentYear, i).toLocaleString('pt-PT', { month: 'short' }));
        kWhData.push(totalKWh.toFixed(2));
        euroData.push(totalCost.toFixed(2));
      }

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'kWh',
              data: kWhData,
              backgroundColor: 'rgba(75, 192, 192, 0.6)'
            },
            {
              label: '€',
              data: euroData,
              backgroundColor: 'rgba(255, 206, 86, 0.6)'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function prevMonth() {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      updateTable();
      updateMonthLabel();
    }

    function nextMonth() {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      updateTable();
      updateMonthLabel();
    }

    function updateMonthLabel() {
      const date = new Date(currentYear, currentMonth);
      monthLabel.textContent = date.toLocaleString('pt-PT', { month: 'long', year: 'numeric' });
      document.getElementById('monthTitle').textContent = `Registos de ${monthLabel.textContent}`;
    }

    window.onload = () => {
      updateMonthLabel();
      updateTable();
      updateChart();
    };
  </script>
</body>
</html>
