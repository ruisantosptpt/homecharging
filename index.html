<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home Charger Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #0d0d0d;
      color: white;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #1a1a1a;
      padding: 10px 20px;
    }

    .container {
      display: flex;
      padding: 20px;
    }

    .left-panel, .right-panel {
      flex: 1;
      margin: 0 10px;
      background-color: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
    }

    h2 {
      margin-top: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #333;
      text-align: left;
    }

    .settings {
      display: none;
      background-color: #1a1a1a;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 10px;
    }

    .settings.visible {
      display: block;
    }

    .insert-consumption {
      background-color: #1a1a1a;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 10px;
    }

    .month-nav {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .month-nav button {
      margin: 0 10px;
      padding: 5px 10px;
    }

    input {
      margin: 0 10px 10px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>Home Charger Tracker</h1>
    <div>
      <button onclick="prevMonth()">‚Üê</button>
      <span id="monthLabel"></span>
      <button onclick="nextMonth()">‚Üí</button>
      <button onclick="toggleSettings()">‚öôÔ∏è</button>
    </div>
  </header>

  <div class="insert-consumption">
    <label>Valor: <input type="number" id="valueInput" /></label>
    <label>Data: <input type="date" id="dateInput" /></label>
    <button onclick="addEntry('kWh')">kWh</button>
    <button onclick="addEntry('%')">%</button>
  </div>

  <div class="settings" id="settingsPanel">
    <label>Pre√ßo kWh (‚Ç¨): <input type="number" id="priceKWh" step="0.01" /></label><br>
    <label>Pre√ßo Gas√≥leo (‚Ç¨): <input type="number" id="priceDiesel" step="0.01" /></label><br>
    <label>Meta Mensal (‚Ç¨): <input type="number" id="monthlyGoal" /></label><br>
    <label>Equival√™ncia (% ‚Üí kWh): <input type="number" id="percentToKWh" placeholder="ex: 20% = 10kWh insere 10" /></label><br>
    <button onclick="saveSettings()">Guardar Defini√ß√µes</button>
  </div>

  <div class="container">
    <div class="left-panel">
      <h2 id="monthTitle"></h2>
      <table id="dataTable">
        <thead>
          <tr><th>Data</th><th>kWh</th><th>Custo</th><th></th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td>Total</td><td id="totalKWh"></td><td id="totalCost"></td><td></td></tr>
        </tfoot>
      </table>
    </div>
    <div class="right-panel">
      <h2>Gr√°fico Anual</h2>
      <canvas id="annualChart"></canvas>
    </div>
  </div>

  <script>
    const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let data = JSON.parse(localStorage.getItem("chargingData") || "{}");
    let settings = JSON.parse(localStorage.getItem("settings") || "{}");

    function saveSettings() {
      settings.priceKWh = parseFloat(document.getElementById("priceKWh").value) || 0;
      settings.priceDiesel = parseFloat(document.getElementById("priceDiesel").value) || 0;
      settings.monthlyGoal = parseFloat(document.getElementById("monthlyGoal").value) || 0;
      settings.percentToKWh = parseFloat(document.getElementById("percentToKWh").value) || 0;
      localStorage.setItem("settings", JSON.stringify(settings));
      alert("Defini√ß√µes guardadas!");
      toggleSettings(); // esconde ap√≥s guardar
      render();
    }

    function toggleSettings() {
      const panel = document.getElementById("settingsPanel");
      panel.classList.toggle("visible");
    }

    function getMonthKey(year, month) {
      return `${year}-${month + 1}`;
    }

    function addEntry(type) {
      const value = parseFloat(document.getElementById("valueInput").value);
      const date = document.getElementById("dateInput").value;
      if (!value || !date) return alert("Preenche todos os campos.");

      const kWh = type === "%" ? (settings.percentToKWh ? (value * settings.percentToKWh) / 20 : 0) : value;
      if (type === "%" && !settings.percentToKWh) return alert("Define a equival√™ncia % ‚Üí kWh nas defini√ß√µes.");

      const dt = new Date(date);
      const key = getMonthKey(dt.getFullYear(), dt.getMonth());
      if (!data[key]) data[key] = [];
      data[key].push({ date, kWh });
      localStorage.setItem("chargingData", JSON.stringify(data));
      render();
    }

    function render() {
      document.getElementById("monthLabel").innerText = `${monthNames[currentMonth]} ${currentYear}`;
      document.getElementById("monthTitle").innerText = `${monthNames[currentMonth]} ${currentYear}`;

      const key = getMonthKey(currentYear, currentMonth);
      const entries = (data[key] || []).sort((a, b) => new Date(a.date) - new Date(b.date));

      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      let totalKWh = 0;
      let totalCost = 0;

      entries.forEach((entry, i) => {
        const dt = new Date(entry.date);
        const cost = (settings.priceKWh || 0) * entry.kWh;
        totalKWh += entry.kWh;
        totalCost += cost;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${dt.toLocaleDateString("pt-PT", { weekday: "long", day: "numeric" })}</td>
          <td>${entry.kWh.toFixed(2)}</td>
          <td>‚Ç¨${cost.toFixed(2)}</td>
          <td><button onclick="deleteEntry(${i})">üóëÔ∏è</button></td>`;
        tbody.appendChild(tr);
      });

      document.getElementById("totalKWh").innerText = totalKWh.toFixed(2);
      document.getElementById("totalCost").innerText = `‚Ç¨${totalCost.toFixed(2)}`;

      renderChart();
    }

    function deleteEntry(index) {
      const key = getMonthKey(currentYear, currentMonth);
      if (confirm("Eliminar entrada?")) {
        data[key].splice(index, 1);
        localStorage.setItem("chargingData", JSON.stringify(data));
        render();
      }
    }

    function prevMonth() {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      render();
    }

    function nextMonth() {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      render();
    }

    let chart;
    function renderChart() {
      const annualData = Array(12).fill(0);
      for (let m = 0; m < 12; m++) {
        const key = getMonthKey(currentYear, m);
        if (data[key]) {
          annualData[m] = data[key].reduce((sum, e) => sum + e.kWh, 0);
        }
      }

      if (chart) chart.destroy();
      const ctx = document.getElementById("annualChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: monthNames,
          datasets: [{
            label: "Consumo (kWh)",
            data: annualData,
            backgroundColor: "#e63946"
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    window.onload = () => {
      // pr√©-preencher os settings
      document.getElementById("priceKWh").value = settings.priceKWh || "";
      document.getElementById("priceDiesel").value = settings.priceDiesel || "";
      document.getElementById("monthlyGoal").value = settings.monthlyGoal || "";
      document.getElementById("percentToKWh").value = settings.percentToKWh || "";
      render();
    };
  </script>
</body>
</html>
