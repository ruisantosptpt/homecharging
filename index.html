<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home Charger Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #0d0d0d;
      color: white;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #1a1a1a;
      padding: 10px 20px;
    }

    .container {
      display: flex;
      padding: 20px;
    }

    .left-panel, .right-panel {
      flex: 1;
      margin: 0 10px;
      background-color: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
    }

    h2 {
      margin-top: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #333;
      text-align: left;
    }

    .settings {
      display: none;
      background-color: #1a1a1a;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 10px;
    }

    .settings.visible {
      display: block;
    }

    .insert-consumption {
      background-color: #1a1a1a;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 10px;
    }

    .month-nav {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .month-nav button {
      margin: 0 10px;
      padding: 5px 10px;
    }

    input {
      margin: 0 10px 10px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>Home Charger Tracker</h1>
    <div>
      <button onclick="prevMonth()">←</button>
      <span id="monthLabel"></span>
      <button onclick="nextMonth()">→</button>
      <button onclick="toggleSettings()">⚙️</button>
    </div>
  </header>

  <div class="insert-consumption">
    <label>Valor: <input type="number" id="valueInput" /></label>
    <label>Data: <input type="date" id="dateInput" /></label>
    <button onclick="addEntry('kWh')">kWh</button>
    <button onclick="addEntry('%')">%</button>
  </div>

  <div class="settings" id="settingsPanel">
    <label>Preço kWh (€): <input type="number" id="priceKWh" step="0.01" value="0.25" /></label><br>
    <label>Preço Gasóleo (€): <input type="number" id="priceDiesel" step="0.01" value="1.75" /></label><br>
    <label>Meta Mensal (€): <input type="number" id="monthlyGoal" step="0.01" value="50" /></label>
  </div>

  <div class="container">
    <div class="left-panel">
      <h2 id="monthTitle"></h2>
      <table id="dataTable">
        <thead>
          <tr><th>Data</th><th>kWh</th><th>Custo (€)</th><th></th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td>Total</td><td id="totalKWh"></td><td id="totalCost"></td><td></td></tr>
        </tfoot>
      </table>
    </div>
    <div class="right-panel">
      <h2>Gráfico Anual</h2>
      <canvas id="yearChart"></canvas>
    </div>
  </div>

  <script>
    const entries = JSON.parse(localStorage.getItem("entries") || "[]");
    const settings = {
      priceKWh: parseFloat(document.getElementById("priceKWh").value) || 0.25,
    };

    let currentMonth = new Date().getMonth();
    const monthLabel = document.getElementById("monthLabel");
    const monthTitle = document.getElementById("monthTitle");

    function updateSettings() {
      settings.priceKWh = parseFloat(document.getElementById("priceKWh").value) || 0.25;
    }

    function toggleSettings() {
      document.getElementById("settingsPanel").classList.toggle("visible");
    }

    function updateMonthLabel() {
      const now = new Date();
      now.setMonth(currentMonth);
      monthLabel.textContent = now.toLocaleString('pt-PT', { month: 'long', year: 'numeric' });
      monthTitle.textContent = `Consumos - ${monthLabel.textContent}`;
    }

    function prevMonth() {
      currentMonth = (currentMonth - 1 + 12) % 12;
      render();
    }

    function nextMonth() {
      currentMonth = (currentMonth + 1) % 12;
      render();
    }

    function addEntry(type) {
      updateSettings();
      const value = parseFloat(document.getElementById("valueInput").value);
      const date = document.getElementById("dateInput").value;
      if (!value || !date) return;

      const kWh = type === 'kWh' ? value : value * 0.7;
      const cost = kWh * settings.priceKWh;

      entries.push({ date, kWh, cost });
      localStorage.setItem("entries", JSON.stringify(entries));
      render();
    }

    function deleteEntry(index) {
      entries.splice(index, 1);
      localStorage.setItem("entries", JSON.stringify(entries));
      render();
    }

    function render() {
      updateMonthLabel();

      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      let totalKWh = 0;
      let totalCost = 0;

      entries.forEach((entry, index) => {
        const entryDate = new Date(entry.date);
        if (entryDate.getMonth() === currentMonth) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${entry.date}</td>
            <td>${entry.kWh.toFixed(2)}</td>
            <td>€ ${entry.cost.toFixed(2)}</td>
            <td><button onclick="deleteEntry(${index})">❌</button></td>
          `;
          tbody.appendChild(tr);
          totalKWh += entry.kWh;
          totalCost += entry.cost;
        }
      });

      document.getElementById("totalKWh").textContent = totalKWh.toFixed(2);
      document.getElementById("totalCost").textContent = `€ ${totalCost.toFixed(2)}`;

      renderChart();
    }

    let chart;
    function renderChart() {
      const months = Array.from({ length: 12 }, (_, i) => new Date(0, i).toLocaleString('pt-PT', { month: 'short' }));
      const monthlyKWh = Array(12).fill(0);
      const monthlyCost = Array(12).fill(0);

      entries.forEach(entry => {
        const d = new Date(entry.date);
        const m = d.getMonth();
        monthlyKWh[m] += entry.kWh;
        monthlyCost[m] += entry.cost;
      });

      if (chart) chart.destroy();
      const ctx = document.getElementById("yearChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: months,
          datasets: [
            {
              label: "kWh",
              data: monthlyKWh,
              backgroundColor: "#4bc0c0"
            },
            {
              label: "€",
              data: monthlyCost,
              backgroundColor: "#ff9f40"
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: "white" }
            }
          },
          scales: {
            x: { ticks: { color: "white" } },
            y: { ticks: { color: "white" }, beginAtZero: true }
          }
        }
      });
    }

    render();
  </script>
</body>
</html>
